# Режимы адресации процессора Intelx86

Режим адресации — это способ формирования исполнительного (эффективного) адреса операнда и результата на основе информации, содержащейся в адресной части команды. В большинстве случаев эффективный адрес требует преобразования в физический адрес с использованием механизма сегментации.

К основным режимам адресации относят следующие режимы:

1. Прямая адресация
2. Относительная адресация
3. Косвенная адресация
4. Непосредственная адресация
5. Неявная адресация

## Постбайт адресации

 В первом байте кода операции первые 6 бит — это двоичный код операции, далее следует бит D — он задает направление, после — бит W, который задает размерность операции.

Режим адресации устанавливается во втором байте кода операции (постбайт адресации, он же байт mod r/m). Местоположение источника и приемника закодировано в полях REG и R/M. Если бит D = 1, то источник определяется полем R/M, приемник — полем REG; если D = 0, то наоборот. При W = 0 размерность данных — байт, при W = 1 — слово или двойное слово. Таким образом, команды, использующие постбайт адресации реализуют операции следующих типов:

* reg — reg (регистр — регистр)
* reg — mem (регистр — память)
* mem — reg (память — регистр)

## Поле MOD

Поле MOD определяет метод адресации и наличие смещения при адресации памяти. Код 11 означает регистровую адресацию, код регистра в поле R/M. При MOD = 00, 01, 10 поле R/M задает метод адресации памяти. 

Коды поля MOD:

* 00 — смещение отсутствует;
* 01 — смещение задано знаковым байтом;
* 10 — Смещение 16- или 32-х битное (в зависимости от режима);
* 11 — поле R/M содержит код регистра.

## Поле REG

Коды регистров:

| Код | w = 0 (байт) | w = 1  (слово/двойное слово) |
|-----|--------------|------------------------------|
| 000 | AL           | AX/EAX                       |
| 001 | CL           | CX/ECX                       |
| 010 | DL           | DX/EDX                       |
| 011 | BL           | BX/EBX                       |
| 100 | AH           | SP/ESP                       |
| 101 | CH           | BP/EBP                       |
| 110 | DH           | SI/ESI                       |
| 111 | BH           | DI/EDI                       |

## Поле R/M

Коды поля R/M при адресации памяти (MOD != 11):

| Код | Метод адресации (16-битный режим) | Метод адресации (32-битный режим)                        |
|-----|-----------------------------------|----------------------------------------------------------|
| 000 | DS:[BX+SI]                        | DS:[EAX]                                                 |
| 001 | DS:[BX+DI]                        | DS:[ECX]                                                 |
| 010 | SS:[BP+SI]                        | DS:[EDX]                                                 |
| 011 | SS:[BP+DI]                        | DS:[EBX]                                                 |
| 100 | DS:[SI]                           | Базово-индексная адресация с масштабированием (байт SIB) |
| 101 | DS:[DI]                           | SS:[EBP]                                                 |
| 110 | SS:[BP]                           | DS:[ESI]                                                 |
| 111 | DS:[BX]                           | DS:[EDI]                                                 |

Код R/M = 110 при 16-битой адресации неодназначен. Если MOD = 00, то данное сочетание обозначает прямую адресацию. Для 32-битного режима прямая адресация задается значением R/M = 101.

## Байт SIB

Байт SIB (scale-index-base) используется в 32-битном режиме, если MOD != 11 и R/M = 100. Он следует за постбайтом адресации. Используется, когда в формаровании смещения учавствуют два регистра. 

Формат байта SIB: 

Первые два бита задают масштабный коэффициент — 1, 2, 4 или 8; следующие три бита задают адрес 32-битного индексного регистра, следующие три бита задают адрес базового регистра.

## Прямая адресация

При использовании прямой адресации в адресной части команды задается адрес операнда. Существует два вида прямой адресации:

* прямая регистровая адресация;
* прямая адресация памяти.

При прямой регистровой адресации поле MOD = 11, регистры источника и приемника определяются по кодам из полей REG и R/M по таблице выше.

При прямой адресации памяти происходит исключительный случай при MOD = 00, а поле R/M = 101 для 32-битного режима (в 16-битном режиме этот случай происходит при R/M = 110).

Пример прямой адресации памяти при пересылки данных из памяти в регистр:

```
.data
NUMB DD 0FFFFFFFFH

.code
MOV EDX, NUMB
```

Машинный код данной операции (32-битный режим):

```
8b 15 00 40 40 00
```

или 

```
10001011 00010101 00000000 01000000 01000000 00000000
```
 
 Здесь первый байт 8b (10001011) — код операции; первые 6 бит 100010 указывает на то, что выполняется команда MOV, бит D = 1, что означает, что приемник — регистр из поля REG, бит W = 1, что для 32-битного режима задает размерность данных 32 бит.

Следующий байт — постбайт адресации; поле mod = 00 (смещение отсутствует), reg = 010 (регистр-приемник EDX), r/m = 101 (прямая адресация 32-битного режима). 

Следующие 4 байта — адрес значения, помещаемого в регистр EDX.

## Относительная адресация

При использовании относительной адресации в адресной части команды задается адрес регистра, содержимое которого является главной частью адреса, и смещение, являющееся добавкой к главной части адреса.

Существуют следующие виды относительной адресации:

1. Базовая адресация (адресуемый в команде регистр содержит базовый адрес);
2. Индексная адресация (регистр содержит смещение);
3. Базово-индексная адресация;
4. Базово-индексная адресация с масштабированием.

### Базово-индексная адресация

При использовании базово-индексной адресации выделяются три поля — база, индекс и смещение, а исполнительный адрес формируется как их сумма. Поля база и индекс содержат содержат адреса РОН. Частным случаем является базово-индексная адресация без смещения, когда смещение отсутствует.

При использовании базово-индексной адресации с масштабированием индекс умножается на заданный масштаб, обычно это 2, 4 или 8.

Пример базово-индексной адресации с масштабированием:

```
    .data	
	
	arr1 DD 11111111H,22222222H,33333333H,44444444H
	arr2 DD 55555555H,66666666H,77777777H,88888888H

    .code

    ...

	mov ebx, offset arr2
	mov ecx, 3
	mov eax, [ebx+4*ecx]

```

В регистр ebx помещается адрес начала массива arr2, в регистр ecx помещается индекс требуемого элемента. 

Машинный код операции `mov eax, [ebx+4*ecx]`:

`8b 04 8b`, или `10001011 00000100 10001011`

Первый байт — код операции; первые 6 бит означают команду MOV. Второй байт — постбайт адресации; значение MOD = 00, REG = 000 (приемник — EAX), R/M = 100 (использование байта SIB). Третий байт — байт SIB; масштаб = 10, (индекс умножается на 4), индекс = 001 (регистр ECX), база = 011 (регистр EBX).  

## Косвенная адресация

При использовании косвенной адресации в адресной части команды задается адрес адреса операнда. Существует два вида косвенной адресации:

* косвенная регистровая — в команде задается адрес регистра, содержащего адрес операнда, находящегося в памяти;
* косвенная адресация с использованием памяти — в команде задается адрес ячейки памяти, в которой находится адрес операнда.

## Непосредственная адресация и неявная адресация

При использовании непосредственной адресации в адресной части команды задается сам операнд, который является программной константой. Этот тип адресации имеет следующие преимущества по сравнению с прямой:

* экономия памяти, т. к. операнд не требует памяти для хранения;
* экономия времени, т. к. при выборке операнда не требуется вычислять адрес памяти.

При использовании неявной адресации операнд или адрес операнда не задается, а лишь подразумевается. Примером может служить команда INC, которая инкрементирует (увеличивает на единицу) значение в памяти или регистре, но единица лишь подразумевается, а не задается явно.

Непосредственная и неявная адресации задаются не с помощью постбайта адресации, а с помощью кода операции

&nbsp;
<hr>

> [Список вопросов](Вопросы_ТПП.md)